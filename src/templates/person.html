{% extends 'layout.html' %}

{% block content %}

<style>
  .idnow {
      min-width: 85px;
      height: 30px;
      background-repeat: no-repeat;
      background-image: url( data:image/png;base64,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);
  }
</style>

<ul class="nav nav-tabs">
  <li role="presentation"><a href="/__BACKOFFICE__/">⬅ Persons</a></li>
<li role="presentation" class="active"><a href="/__BACKOFFICE__/person/{{ person.id }}">Individual user</a></li>
  <li role="presentation"><a href="/__BACKOFFICE__/person/{{ person.id }}/cards">Cards</a></li>
</ul>

<div class="page-header">
  <h2>{{ person.email }}</h2>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-heading"><h4>Person data</h4></div>
      <div class="panel-body">
        <form method="POST">
          <div class="from-group">
            <label class="radio-inline">
              <input type="radio" name="salutation" value="MR"{% if person.salutation == 'MR' %}checked{% endif %}> MR
            </label>
            <label class="radio-inline">
              <input type="radio" name="salutation" value="MS"{% if person.salutation == 'MS' %}checked{% endif %}> MS
            </label>
            <br><br>
          </div>
          <div class="row">
            <div class="form-group col-md-6">
              <label for="first_name">First name</label>
              <input type="text" class="form-control" name="first_name" id="first_name" placeholder="First name" value={{ person.first_name }}>
            </div>
            <div class="form-group col-md-6">
              <label for="last_name">Last name</label>
              <input type="text" class="form-control" name="last_name" id="last_name" placeholder="Last name" value={{ person.last_name }}>
            </div>
          </div>
          <div class="form-group">
            <label for="mobile_number">Mobile number</label>
            <input type="text" class="form-control" name="mobile_number" id="mobile_number" placeholder="Phone number" value={{ mobileNumber.number }}>
          </div>
          {% if person.changeRequest %}
          <div class="form-group">
            <label for="mobile_number_token">{{person.changeRequest.method}} verification token</label>
            <div>{{ person.changeRequest.token }}</div>
          </div>
          {% endif %}
          <div class="row">
            <div class="form-group col-md-6">
              <label for="line_1">Address line_1</label>
              <input type="text" class="form-control" name="line_1" id="line_1" placeholder="Address line_1" value={{ person.address.line_1 }}>
            </div>
            <div class="form-group col-md-6">
              <label for="line_2">Address line_2</label>
              <input type="text" class="form-control" name="line_2" id="line_2" placeholder="Address line_2" value={{ person.address.line_2 }}>
            </div>
          </div>
          <div class="row">
            <div class="form-group col-md-4">
              <label for="city">City</label>
              <input type="text" class="form-control" name="city" id="city" placeholder="City" value={{ person.address.city }}>
            </div>
            <div class="form-group col-md-4">
              <label for="postal_code">Postal code</label>
              <input type="text" class="form-control" name="postal_code" id="postal_code" placeholder="Postal code" value={{ person.address.postal_code }}>
            </div>
            <div class="form-group col-md-4">
              <label for="country">Country</label>
              <input type="text" class="form-control" name="country" id="country" placeholder="Country" value={{ person.address.country }}>
            </div>
          </div>
          <div class="form-group">
            <label for="fatca_relevant">FATCA relevant</label>
            <select class="form-control" name="fatca_relevant">
              <option value="true" {% if person.fatca_relevant === true %}selected{% endif %}>true</option>
              <option value="false" {% if person.fatca_relevant === false %}selected{% endif %}>false</option>
              <option value="null" {% if person.fatca_relevant === null %}selected{% endif %}>null</option>
            </select>
          </div>
          <div class="form-group">
            <label for="terms_conditions_signed_at">Terms and conditions signed at</label>
            <input type="text" class="form-control" name="terms_conditions_signed_at" id="terms_conditions_signed_at" disabled="disabled" value={{ person.terms_conditions_signed_at }}>
          </div>
          <div class="form-group">
            <label for="own_economic_interest_signed_at">Own economic interest signed at</label>
            <input type="text" class="form-control" name="own_economic_interest_signed_at" id="own_economic_interest_signed_at" disabled="disabled" value={{ person.own_economic_interest_signed_at }}>
          </div>
          <div class="form-group">
            <label for="fatca_crs_confirmed_at">FATCA and CRS confirmed at</label>
            <input type="text" class="form-control" name="fatca_crs_confirmed_at" id="fatca_crs_confirmed_at" disabled="disabled" value={{ person.fatca_crs_confirmed_at }}>
          </div>
          <p><strong>Company name:</strong> {{ person.business_trading_name }}</p>
          <button type="submit" class="btn btn-primary btn-block">Submit</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-6">

    {% if person.account %}
    <!-- New Booking -->
    <div class="panel panel-default">
      <div class="panel-heading"><h4>Enqueue a new booking</h4></div>
      <div class="panel-body">
        <form method="POST" action="/__BACKOFFICE__/queueBooking/{{ person.id }}">
          <div class="form-group">
            <label>Amount (in cents)</label>
            <input class="form-control" type="number" name="amount" placeholder="amount (in cents)" autocomplete="off" required min="-10000000" max="10000000" />
          </div>
          <div class="form-group">
            <label>Sender</label>
            <input class="form-control" type="text" name="senderName" placeholder="sender name" />
            <input class="form-control" type="text" name="iban" placeholder="IBAN" value="" />
          </div>
          <div class="form-group">
            <label>Purpose</label>
            <input class="form-control" type="text" name="purpose" placeholder="purpose" />
            <input class="form-control" type="text" name="endToEndId" placeholder="end to end id" value="" />
            <input class="form-control" type="text" name="transactionId" placeholder="Transaction id" value="" />
          </div>
          <div class="form-group">
            <select class="form-control" name="bookingType">
              <option selected="selected" value="SEPA_CREDIT_TRANSFER">SEPA_CREDIT_TRANSFER</option>
              <option value="SEPA_DIRECT_DEBIT">SEPA_DIRECT_DEBIT</option>
            </select>
            <br>
            <button type="submit" class="btn btn-primary btn-block">
              Save booking to queue
            </button>
          </div>
        </form>
      </div>
    </div>
    {% else %}
      <i>This person does not have an account.</i>
    {% endif %}

    <!-- Seizures -->
    <div class="panel panel-default">
      <div class="panel-heading"><h4>Seizures</h4></div>
      <div class="panel-body">
        {% if person.seizure %}
          {% if person.seizure.status == SEIZURE_STATUSES.ACTIVE %}
            <div class="alert alert-danger">
              Person has active seizure!
            </div>

            <form method="POST" action="/__BACKOFFICE__/fulfillSeizure/{{ person.id }}">
              <button type="submit" class="btn btn-success btn-block">
                Fulfill Seizure
              </button>
            </form>

            <br>
          {% elseif person.seizure.status == SEIZURE_STATUSES.FULFILLED %}
            <div class="alert alert-success">
              Person has fulfilled seizure
            </div>
          {% endif %}

          <form method="POST" action="/__BACKOFFICE__/deleteSeizure/{{ person.id }}">
            <button type="submit" class="btn btn-danger btn-block">
              Delete Seizure
            </button>
          </form>

          <br>

          <div class="panel-group">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#seizureRawData">
                    Raw seizure data
                  </a>
                  <span class="caret"></span>
                </h4>
              </div>
              <div id="seizureRawData" class="panel-collapse collapse">
                <div class="panel-body">
                  <pre>{{ JSON.stringify(person.seizure, undefined, 2) }}</pre>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="alert alert-info">
            Person has no seizures!
          </div>

          <form method="POST" action="/__BACKOFFICE__/createSeizure/{{ person.id }}">
            <button type="submit" class="btn btn-primary btn-block">
              Create Seizure
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<h3 id="account"> Account for {{ person.email }} </h3>
{% if person.account %}

<div class="panel panel-default">
  <div class="panel-heading">About this account</div>
  <table class="table">
    <tr>
      <td>Balance</td>
      <td>{{ person.account.balance.value / 100 }} €</td>
    </tr>
    <tr>
      <td>Available balance</td>
      <td>{{ person.account.available_balance.value / 100 }} €</td>
    </tr>
    <tr>
      <td>Limit</td>
      <td>{{ person.account.account_limit.value / 100 }} €</td>
    </tr>
    <tr>
      <td>Overdraft Interest</td>
      <td>
        <form method="POST" action="/__BACKOFFICE__/issueInterestAccruedBooking/{{ person.id }}">
          {{ person.account.overdraftInterest / 100 }} €
          <button type="submit" class="btn btn-warning btn-sm" {% if person.account.overdraftInterest <= 0 %} disabled {% endif %}>
            Issue
          </button>
        </form>
      </td>
    </tr>
    <tr>
      <td>Block status</td>
      <td>
        <form method="POST" action="/__BACKOFFICE__/updateAccountLockingStatus/{{ person.id }}">
          <fieldset {% if person.seizure && person.seizure.status == SEIZURE_STATUSES.ACTIVE %}disabled{%endif %}>
            <select name="lockingStatus">
              <option value="" {% if person.account.locking_status == '' %} selected {% endif %}>(not set)</option>
              <option value="NO_BLOCK" {% if person.account.locking_status == 'NO_BLOCK' %} selected {% endif %}>NO_BLOCK</option>
              <option value="CREDIT_BLOCK" {% if person.account.locking_status == 'CREDIT_BLOCK' %} selected {% endif %}>CREDIT_BLOCK</option>
              <option value="DEBIT_BLOCK" {% if person.account.locking_status == 'DEBIT_BLOCK' %} selected {% endif %}>DEBIT_BLOCK</option>
              <option value="BLOCK" {% if person.account.locking_status == 'BLOCK' %} selected {% endif %}>BLOCK</option>
            </select>
            <button type="submit" class="btn btn-warning btn-sm">
              Update account locking status
            </button>
          </fieldset>
        </form>
      </td>
    </tr>
  </table>
</div>

{% if person.account.overdraftApplications.length > 0 %}
<div class="panel panel-default">
  <div id="overdraft" class="panel-heading">Overdrafts</div>
  <table class="table">
    <thead>
      <tr>
        <th>id</th>
        <th>status</th>
        <th>decision</th>
        <th>limit</th>
      </tr>
    </thead>
    {% for application in person.account.overdraftApplications %}
    <tr>
      <td>
        {{ application.id }}
      </td>
      <td>
        {{ application.status }}<br>
        <form class="form-inline autosubmitonchange" method="POST" action="/__BACKOFFICE__/changeOverdraftApplicationStatus">
          <select name="status" {% if application.status==="rejected" %}disabled {% endif %}>
            <option selected>change status</option>
            <option {% if application.status!=="account_snapshot_verification_pending" %} disabled {% endif %}value="offered">offered</option>
            <option {% if application.status!=="offered" %} disabled {% endif %}value="expired">expired</option>
            <option value="rejected">rejected</option>
          </select>
          <input type="hidden" name="personId" value={{ person.id }}>
          <input type="hidden" name="applicationId" value={{ application.id }}>
        </form>
      </td>
      <td>
        {{ application.decision }}
      </td>
      <td>
        {{ application.limit.value }}
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}

<div class="panel panel-default">
  <div id="queuedBookings" class="panel-heading">Queued bookings</div>
  {% if person.queuedBookings.length > 0 %}
  <table class="table">
    <thead>
      <tr>
        <th>id<br>type<br>status</th>
        <th>amount</th>
        <th>
          booking date<br>
          valuta date
        </th>
        <th>
          description<br>
          name
        </th>
        <th>recipient</th>
        <th>sender</th>
      </tr>
    </thead>
    {% for queuedBooking in person.queuedBookings %}
      <tr>
        <td>
          {{ queuedBooking.id }}
          <br>
            <span class="label label-primary">
              {{ queuedBooking.booking_type }}
            </span>
          {% if queuedBooking.status %}
            <br><span class="label label-default">{{ queuedBooking.status }}</span>
          {% endif %}
        </td>
        <td>{{ (queuedBooking.amount.value / 100).toFixed(2) }}€</td>
        <td>
          {{ queuedBooking.booking_date }}<br>
          {{ queuedBooking.valuta_date }}
        </td>
        <td>
          {{ queuedBooking.description }}<br>
          {{ queuedBooking.name }}
        </td>
        <td>
          {{ queuedBooking.recipient_name }}<br>
          {{ queuedBooking.recipient_iban }}<br>
          {{ queuedBooking.recipient_bic }}
        </td>
        <td>
          {{ queuedBooking.sender_name }}<br>
          {{ queuedBooking.sender_iban }}<br>
          {{ queuedBooking.sender_bic }}
        </td>
        <td>
        <form method="POST" action="/__BACKOFFICE__/processQueuedBooking/{{ person.id }}/{{ queuedBooking.id }}">
          <button type="submit" class="btn btn-default">
            ➡️ Process
          </button>
        </form>
        </td>
      </tr>
    {% endfor %}
  </table>
  {% else %}
    <div class="panel-body">
      No queued bookings ☹️
    </div>
  {% endif %}
</div>


<div class="panel panel-default">
  <div id="bookings" class="panel-heading">Bookings</div>

  {% if person.transactions.length > 0 %}

  <table class="table">
    <thead>
      <tr>
        <th>id<br>type</th>
        <th>amount</th>
        <th>booking date<br>valuta date</th>
        <th>
          description<br>
          name
        </th>
        <th>recipient</th>
        <th>sender</th>
      </tr>
    </thead>
    {% for transaction in person.transactions %}
      <tr>
        <td>
          {{ transaction.id }}
          <br>
          <span class="label label-primary">
            {{ transaction.booking_type }}
          </span>
        </td>
        <td>{{ (transaction.amount.value / 100).toFixed(2) }}€</td>
        <td>
          {{ transaction.booking_date }}<br>
          {{ transaction.valuta_date }}
        </td>
        <td>
          {{ transaction.description }}<br>
          {{ transaction.name }}
        </td>
        <td>
          {{ transaction.recipient_name }}<br>
          {{ transaction.recipient_iban }}<br>
          {{ transaction.recipient_bic }}
        </td>
        <td>
          {{ transaction.sender_name }}<br>
          {{ transaction.sender_iban }}<br>
          {{ transaction.sender_bic }}
        </td>
      </tr>
    {% endfor %}
  </table>

{% else %}
  <div class="panel-body">
    No bookings ☹️
  </div>
{% endif %}
</div>

<div class="panel panel-default">
  <div id="bookings" class="panel-heading">Standing Orders</div>

  {% if person.standingOrders.length > 0 %}

  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Recipient Name</th>
        <th>IBAN</th>
        <th>Amount</th>
        <th>Purpose</th>
        <th>End to end ID</th>
        <th>First Execution Date</th>
        <th>Last Execution Date</th>
        <th>Reoccurrence</th>
        <th>Next Occurrence</th>
        <th>Trigger</th>
      </tr>
    </thead>
    {% for standingOrder in person.standingOrders %}
      <tr>
        <td>{{ person.id }}</td>
        <td>{{ standingOrder.recipient_name }}</td>
        <td>{{ standingOrder.recipient_iban }}</td>
        <td>{{ (Math.abs(standingOrder.amount.value) / 100).toFixed(2) }}€</td>
        <td>{{ standingOrder.description }}</td>
        <td>{{ standingOrder.end_to_end_id }}</td>
        <td>{{ standingOrder.first_execution_date }}</td>
        <td>{{ standingOrder.last_execution_date }}</td>
        <td>{{ standingOrder.reoccurrence }}</td>
        <td>{{ standingOrder.next_occurrence }}</td>
        {% if standingOrder.status === "ACTIVE" %}
          <td>
            <form method="POST" action="/__BACKOFFICE__/triggerStandingOrder/{{ person.id }}/{{ standingOrder.id }}">
                <button type="submit" class="btn btn-default">
                  ➡️ Trigger now
                </button>
            </form>
          </td>
        {% else %}
          <td>{{ standingOrder.status }}</td>
        {% endif %}
      </tr>
    {% endfor %}
  </table>

{% else %}
  <div class="panel-body">
    No Standing Orders ☹️
  </div>
{% endif %}
</div>

{% else %}
  <div class="panel-body">
    <i>This person does not have an account.</i>
  </div>
{% endif %}

<div class="panel panel-default">
  <div id="identifications" class="panel-heading"> Identifications for {{ person.email }}</div>
  {% if Object.keys(identifications).length > 0 %}
  <table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>created at</th>
      <th>method</th>
      <th>reference</th>
      <th>status</th>
      <th></th>
    </tr>
  </thead>

  {% for identification in identifications %}
    <tr>
      <td>{{ identification.id }}</td>
      <td>
        {{ identification.identificationLinkCreatedAt || identification.createdAt }}
      </td>
      <td class="{{ identification.method }}"></td>
      <td>{{ identification.reference }}</td>
      <td>
        <form class="form-inline autosubmitonchange" method="POST" action="/__BACKOFFICE__/setIdentificationState/{{ person.email }}?method={{ identification.method }}">
          <select name="status">
              <option {% if identification.status === "pending" %}selected {% endif %}value="pending">pending</option>
              <option {% if identification.status === "pending_successful" %}selected {% endif %}value="pending_successful">pending_successful</option>
              <option {% if identification.status === "pending_failed" %}selected {% endif %}value="pending_failed">pending_failed</option>
              <option {% if identification.status === "successful" %}selected {% endif %}value="successful">successful</option>
              <option {% if identification.status === "failed" %}selected {% endif %}value="failed">failed</option>
              <option {% if identification.status === "canceled" %}selected {% endif %}value="canceled">canceled</option>
              <option {% if identification.status === "aborted" %}selected {% endif %}value="aborted">aborted</option>
          </select>
        </form>
      </td>
    </tr>
  {% endfor %}
  </table>
  {% else %}
  <div class="panel">
    <i>No identifications for this person</i>
  </div>
  {% endif %}
</div>

<div class="panel panel-default">
  <div id="timedOrders" class="panel-heading">Timed Orders</div>

  {% if person.timedOrders.length > 0 %}
    <table class="table">
    <thead>
      <tr>
          <th>ID</th>
          <th>execute_at</th>
          <th>executed_at</th>
          <th>status</th>
          <th>amount</th>
          <th>description</th>
          <th>recipient_iban</th>
          <th>recipient_name</th>
          <th>end_to_end_id</th>
          <th>Trigger</th>
      </tr>
    </thead>
    {% for timedOrder in person.timedOrders %}
      <tr>
          <td>{{ timedOrder.id }}</td>
          <td>{{ timedOrder.execute_at }}</td>
          <td>{{ timedOrder.executed_at }}</td>
          <td>{{ timedOrder.status }}</td>
          <td>-{{ (timedOrder.scheduled_transaction.amount.value / 100).toFixed(2) }}€</td>
          <td>{{ timedOrder.scheduled_transaction.description }}</td>
          <td>{{ timedOrder.scheduled_transaction.recipient_iban }}</td>
          <td>{{ timedOrder.scheduled_transaction.recipient_name }}</td>
          <td>{{ timedOrder.scheduled_transaction.end_to_end_id }}</td>
          <td>
            {% if timedOrder.status === "SCHEDULED" %}
            <form method="POST" action="/__BACKOFFICE__/triggerTimedOrder/{{ person.id }}/{{ timedOrder.id }}">
                <button type="submit" class="btn btn-default">
                  ➡️ Trigger now
                </button>
            </form>
            {% endif %}
          </td>
      </tr>
    {% endfor %}
    </table>
    <div class="panel-body"></div>
      <form method="POST" action="/__BACKOFFICE__/processTimedOrders/{{ person.id }}">
        <button type="submit" class="btn btn-danger btn-block">
          Process timed orders
        </button>
      </form>
    </div>
  {% else %}
    <div class="panel-body">
      <i>No timed orders :(</i>
    </div>
  {% endif %}
</div>

<div class="panel panel-default">
  <div id="taxIdentifications" class="panel-heading">Tax identifications for {{ person.email }} </div>

  {% if taxIdentifications.length > 0 %}
    <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Country</th>
        <th>Number</th>
        <th>Primary ?</th>
        <th>Reason description</th>
      </tr>
    </thead>
    {% for taxIdentification in taxIdentifications %}
      <tr>
        <td>{{ taxIdentification.id }}</td>
        <td>{{ taxIdentification.country }}</td>
        <td>{{ taxIdentification.number }}</td>
        <td>
          {% if taxIdentification.primary %} ✅ {% else %} ❌ {% endif %}
        </td>
        <td>{{ taxIdentification.reason_description }}</td>
      </tr>
    {% endfor %}
    </table>
  {% else %}
    <div class="panel-body">
      <i>No tax identifications for this person</i>
    </div>
  {% endif %}
</div>

<div class="panel panel-default">
  <div id="devices" class="panel-heading">Devices</div>

  {% if devices.length > 0 %}
    <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Key Type</th>
        <th>Verified ?</th>
        <th>Challenge created at</th>
        <th>Challenge expires at</th>
        <th>Public Key</th>
      </tr>
    </thead>
    {% for device in devices %}
      <tr>
        <td>{{ device.id }}</td>
        <td>{{ device.name }}</td>
        <td>{{ device.key_type }}</td>
        <td>
          {% if device.verified %} ✅ {% else %} ❌ {% endif %}
        </td>
        <td>{{ device.signatureChallenge.created_at }}</td>
        <td>{{ device.signatureChallenge.expires_at }}</td>
        <td>{{ device.key }}</td>
      </tr>
    {% endfor %}
    </table>
  {% else %}
    <div class="panel-body">
      <i>No devices created for this person</i>
    </div>
  {% endif %}
</div>

<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingOne">
      <h4 class="panel-title">
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
          Raw person data
        </a>
        <span class="caret"></span>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
      <div class="panel-body">
        <pre>{{ JSON.stringify(person, undefined, 2) }}</pre>
      </div>
    </div>
  </div>
</div>

<script>
$(".autosubmitonchange").change(function() {
  this.submit();
});
</script>

{% endblock %}
